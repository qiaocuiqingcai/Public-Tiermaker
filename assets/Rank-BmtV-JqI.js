import{_ as Y,c as d,o as m,a as c,b as y,w as k,F as P,r as b,n as A,t as Z,d as D,e as L,f as x,g as $,h as ee,i as re}from"./index-9alCvshO.js";const ae={name:"Rank",props:{rankid:{type:[String,Number],default:0},items:{type:Array,default:()=>[{id:1,title:"项目1",imgsrc:"",status:"pending"},{id:2,title:"项目2",imgsrc:"",status:"pending"},{id:3,title:"项目3",imgsrc:"",status:"pending"}]},ranklist:{type:Array,default:()=>[{name:"S",color:"E4504D"},{name:"A",color:"AE5AC8"},{name:"B",color:"8FBAE7"},{name:"C",color:"FBFBFB"}]},rankitems:{type:Array,default:()=>[]}},emits:["update:items","update:rankitems"],setup(f,{emit:t}){const I=Z(f,"rankid");console.log("响应式 rankid 值:",I.value);const e=D([...f.items]),i=D([...f.rankitems]),S=D([...f.ranklist]),l=D(null),s=D(-1),o=D({zone:null,index:-1}),w=D(!1),h=D(""),C=D({}),R=D([]),T=D(""),N=r=>{T.value="";const n=Array.from(r.target.files);n.length!==0&&(n.forEach(a=>{if(!a.type.startsWith("image/")){T.value=`文件 "${a.name}" 不是图片格式，请重新选择`;return}const v=5*1024*1024;if(a.size>v){T.value=`文件 "${a.name}" 大小不能超过 5MB`;return}const g=new FileReader;g.onload=u=>{const p=u.target.result;R.value.push({url:p,file:a}),e.value.push({id:e.value.length,title:a.name.replace(/\.[^/.]+$/,""),imgsrc:p,status:"pending"})},g.readAsDataURL(a)}),console.log("触发handleFileChange"),r.target.value="")},_=()=>{f.rankitems&&f.rankitems.length>0?i.value=[...f.rankitems]:i.value=Array(f.ranklist.length).fill().map(()=>[])};L(()=>f.items,r=>{e.value=[...r]},{immediate:!0}),L(()=>f.rankitems,r=>{r&&r.length>0&&(i.value=[...r])},{immediate:!0});const z=async()=>{try{const r=await fetch(`/static/img/${I.value}/index.json`);if(!r.ok)throw new Error("索引文件加载失败");const{count:n,files:a}=await r.json(),v=`/static/img/${I.value}/`,g=[];a.forEach((u,p)=>{g.push({id:p+1,title:`静态图片${p+1}`,imgsrc:`${v}${u}`,status:"pending"})}),e.value=g,await U(g),console.log(`从索引文件加载到 ${n} 张静态图片`)}catch(r){console.error("加载静态图片失败：",r),e.value=[{id:1,title:"默认图片",imgsrc:"/static/img/default.png",status:"pending"}]}},U=async r=>{console.log("开始预加载图片，共",r.length,"张");const n=r.map(a=>{if(!a.imgsrc)return console.log("跳过无地址的图片项"),Promise.resolve();if(C.value[a.imgsrc])return console.log("图片已在内存缓存中，无需预加载：",a.imgsrc),Promise.resolve();const v=new Image;return v.src=a.imgsrc,v.onload=()=>{console.log("图片已在浏览器缓存中：",a.imgsrc),C.value[a.imgsrc]=v},new Promise(g=>{const u=new Image;u.src=a.imgsrc,u.onload=()=>{console.log("预加载成功：",a.imgsrc),C.value[a.imgsrc]=u,g()},u.onerror=p=>{console.error("预加载失败：",a.imgsrc,p),g()}})});await Promise.all(n),console.log("所有预加载任务完成")};x(()=>{z(),_()});const O=r=>{r&&(h.value=r,w.value=!0)},j=()=>{w.value=!1,h.value=""},B=D(0),E=D(null),W=(r,n)=>{const a=new Date().getTime();a-B.value<300&&E.value===n?(r.stopPropagation(),r.preventDefault(),O(n.imgsrc),B.value=0,E.value=null):(B.value=a,E.value=n)},M=$(()=>e.value.filter(r=>r.status==="pending")),X=r=>!i.value||r<0||r>=i.value.length?[]:i.value[r]||[],q=(r,n)=>l.value===r&&s.value===n,G=(r,n)=>l.value===r&&s.value===n&&o.value.zone!==r,H=(r,n,a,v)=>{r.dataTransfer.dropEffect="move",r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("itemId",n.id.toString()),o.value={zone:a,index:v},r.target.classList.add("dragging")},J=r=>{r&&r.target&&r.target.classList.remove("dragging"),l.value=null,s.value=-1},K=(r,n)=>{r.preventDefault(),l.value=n;const a=V(n);s.value=a?a.length:0},Q=(r,n,a)=>{r.preventDefault(),l.value=n,s.value=a},V=r=>r==="pending"?M.value:r>=0&&r<i.value.length?i.value[r]:[];return{rankid:I,items:e,pendingItems:M,ranklist:S,rankItems:i,getRankItems:X,dragOverZone:l,dragOverIndex:s,dragSource:o,showPreview:q,isPreviewActive:G,startDrag:H,endDrag:J,onDrop:(r,n)=>{r.preventDefault();try{const a=parseInt(r.dataTransfer.getData("itemId"));if(isNaN(a))return;const v=o.value.zone,g=o.value.index;if(v==="pending"){if(g<0||g>=e.value.length)return}else if(!i.value[v]||g<0||g>=i.value[v].length)return;let u;if(v==="pending"?g>=0&&g<e.value.length&&(u={...e.value[g]},e.value.splice(g,1)):i.value[v]&&g>=0&&g<i.value[v].length&&(u={...i.value[v][g]},i.value[v].splice(g,1)),!u||!u.id)return;if(n==="pending"){e.value=e.value.filter(F=>F.id!==u.id);const p=s.value===-1?e.value.length:Math.min(s.value,e.value.length);e.value.splice(p,0,u)}else{i.value[n]||(i.value[n]=[]),i.value[n]=i.value[n].filter(F=>F.id!==u.id);const p=s.value===-1?i.value[n].length:Math.min(s.value,i.value[n].length);i.value[n].splice(p,0,u)}l.value=null,s.value=-1}catch(a){console.error("拖拽处理错误:",a)}},onDragOver:K,onItemDragOver:Q,showImgPreview:w,previewImgSrc:h,handleImgZoom:O,closeImgPreview:j,handleTouchStart:W,imageList:R,handleFileChange:N}}},ne={id:"app"},te={class:"container"},le=["src"],se={class:"main-content"},oe={class:"tiers-container"},ie=["onDrop","onDragover"],ge=["onDragstart","onDragover","onDblclick","onTouchstart"],ce=["src","onError"],ve={key:1,class:"item-icon"},ue={class:"items-container"},de=["onDragstart","onDragover","onDblclick","onTouchstart"],me=["src","onError"],fe={class:"upload-btn",color:"#BFBFBF",for:"imageUpload"};function he(f,t,I,e,i,S){return m(),d("div",ne,[c("div",te,[e.showImgPreview?(m(),d("div",{key:0,class:"img-preview-layer",onClick:t[2]||(t[2]=(...l)=>e.closeImgPreview&&e.closeImgPreview(...l))},[c("img",{class:"preview-img",src:e.previewImgSrc,alt:"放大预览",onClick:t[0]||(t[0]=k(()=>{},["stop"]))},null,8,le),c("div",{class:"preview-close",onClick:t[1]||(t[1]=(...l)=>e.closeImgPreview&&e.closeImgPreview(...l))},"X")])):y("",!0),t[12]||(t[12]=c("div",{class:"header"},[c("h1",null,"排行榜热门投票")],-1)),c("div",se,[c("div",oe,[(m(!0),d(P,null,b(e.ranklist,(l,s)=>(m(),d("div",{key:s,class:A(["tier",l.color])},[c("div",{class:"tier-label",style:ee({backgroundColor:"#"+l.color})},re(l.name)+"级",5),c("div",{class:"tier-content",onDrop:o=>e.onDrop(o,s),onDragover:k(o=>e.onDragOver(o,s),["prevent"]),onDragenter:t[4]||(t[4]=k(()=>{},["prevent"]))},[(m(!0),d(P,null,b(e.getRankItems(s),(o,w)=>(m(),d(P,{key:o.id},[e.showPreview(s,w)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive(s,w)}])},null,2)):y("",!0),c("div",{class:"drag-item",draggable:"true",onDragstart:h=>e.startDrag(h,o,s,w),onDragend:t[3]||(t[3]=(...h)=>e.endDrag&&e.endDrag(...h)),onDragover:k(h=>e.onItemDragOver(h,s,w),["prevent"]),onDblclick:h=>e.handleImgZoom(o.imgsrc),onTouchstart:h=>e.handleTouchStart(h,o)},[o.imgsrc?(m(),d("img",{key:0,src:o.imgsrc,class:"item-image",alt:"",loading:"lazy",onError:h=>f.handleImgError(o)},null,40,ce)):(m(),d("div",ve,"⭐"))],40,ge)],64))),128)),e.showPreview(s,e.getRankItems(s).length)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive(s,e.getRankItems(s).length)}])},null,2)):y("",!0)],40,ie)],2))),128))]),c("div",ue,[t[11]||(t[11]=c("div",{class:"items-title"},"待处理项目",-1)),c("div",{class:"items-grid",onDrop:t[6]||(t[6]=l=>e.onDrop(l,"pending")),onDragover:t[7]||(t[7]=k(l=>e.onDragOver(l,"pending"),["prevent"])),onDragenter:t[8]||(t[8]=k(()=>{},["prevent"]))},[(m(!0),d(P,null,b(e.pendingItems,(l,s)=>(m(),d(P,{key:l.id},[e.showPreview("pending",s)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive("pending",s)}])},null,2)):y("",!0),c("div",{class:"drag-item",draggable:"true",onDragstart:o=>e.startDrag(o,l,"pending",s),onDragend:t[5]||(t[5]=(...o)=>e.endDrag&&e.endDrag(...o)),onDragover:k(o=>e.onItemDragOver(o,"pending",s),["prevent"]),onDblclick:o=>e.handleImgZoom(l.imgsrc),onTouchstart:o=>e.handleTouchStart(o,l)},[l.imgsrc?(m(),d("img",{key:0,src:l.imgsrc,class:"item-image",alt:"",loading:"lazy",onError:o=>f.handleImgError(l)},null,40,me)):y("",!0)],40,de)],64))),128)),e.showPreview("pending",e.pendingItems.length)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive("pending",e.pendingItems.length)}])},null,2)):y("",!0)],32),c("label",fe,[t[10]||(t[10]=c("span",null,"选择图片（可多选）",-1)),c("input",{type:"file",id:"imageUpload",accept:"image/*",class:"hidden-input",onChange:t[9]||(t[9]=(...l)=>e.handleFileChange&&e.handleFileChange(...l)),multiple:""},null,32)])])]),t[13]||(t[13]=c("div",{class:"footer"},[c("p",null,"SABC分级拖拽系统 © 2023")],-1))])])}const we=Y(ae,[["render",he]]);export{we as default};
