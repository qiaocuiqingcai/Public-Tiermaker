import{_ as Y,c as d,o as m,a as c,b as y,w as k,F as P,r as b,n as A,t as Z,d as h,e as M,f as x,g as $,h as ee,i as re}from"./index-BoUGYtzg.js";const ne={name:"Rank",props:{rankid:{type:[String,Number],default:0},items:{type:Array,default:()=>[{id:1,title:"项目1",imgsrc:"",status:"pending"},{id:2,title:"项目2",imgsrc:"",status:"pending"},{id:3,title:"项目3",imgsrc:"",status:"pending"}]},ranklist:{type:Array,default:()=>[{name:"S",color:"E4504D"},{name:"A",color:"AE5AC8"},{name:"B",color:"8FBAE7"},{name:"C",color:"FBFBFB"}]},rankitems:{type:Array,default:()=>[]}},emits:["update:items","update:rankitems"],setup(D,{emit:t}){const I=Z(D,"rankid");console.log("响应式 rankid 值:",I.value);const e=h([...D.items]),i=h([...D.rankitems]),S=h([...D.ranklist]),l=h(null),o=h(-1),s=h({zone:null,index:-1}),p=h(!1),f=h(""),E=h({}),R=h([]),C=h(""),L=r=>{C.value="";const a=Array.from(r.target.files);a.length!==0&&(a.forEach(n=>{if(!n.type.startsWith("image/")){C.value=`文件 "${n.name}" 不是图片格式，请重新选择`;return}const v=5*1024*1024;if(n.size>v){C.value=`文件 "${n.name}" 大小不能超过 5MB`;return}const g=new FileReader;g.onload=u=>{const w=u.target.result;R.value.push({url:w,file:n}),e.value.push({id:e.value.length,title:n.name.replace(/\.[^/.]+$/,""),imgsrc:w,status:"pending"})},g.readAsDataURL(n)}),console.log("触发handleFileChange"),r.target.value="")},N=()=>{D.rankitems&&D.rankitems.length>0?i.value=[...D.rankitems]:i.value=Array(D.ranklist.length).fill().map(()=>[])};M(()=>D.items,r=>{e.value=[...r]},{immediate:!0}),M(()=>D.rankitems,r=>{r&&r.length>0&&(i.value=[...r])},{immediate:!0});const z=async()=>{try{const r=await fetch(`./static/img/${I.value}/index.json`);if(!r.ok)throw new Error("索引文件加载失败");const{count:a,files:n}=await r.json(),v=`./static/img/${I.value}/`,g=[];n.forEach((u,w)=>{g.push({id:w+1,title:`静态图片${w+1}`,imgsrc:`${v}${u}`,status:"pending"})}),e.value=g,await U(g),console.log(`从索引文件加载到 ${a} 张静态图片`)}catch(r){console.error("加载静态图片失败：",r),e.value=[{id:1,title:"默认图片",imgsrc:"./static/img/default.png",status:"pending"}]}},U=async r=>{console.log("开始预加载图片，共",r.length,"张");const a=r.map(n=>{if(!n.imgsrc)return console.log("跳过无地址的图片项"),Promise.resolve();if(E.value[n.imgsrc])return console.log("图片已在内存缓存中，无需预加载：",n.imgsrc),Promise.resolve();const v=new Image;return v.src=n.imgsrc,v.onload=()=>{console.log("图片已在浏览器缓存中：",n.imgsrc),E.value[n.imgsrc]=v},new Promise(g=>{const u=new Image;u.src=n.imgsrc,u.onload=()=>{console.log("预加载成功：",n.imgsrc),E.value[n.imgsrc]=u,g()},u.onerror=w=>{console.error("预加载失败：",n.imgsrc,w),g()}})});await Promise.all(a),console.log("所有预加载任务完成")};x(()=>{z(),N()});const O=r=>{r&&(f.value=r,p.value=!0)},j=()=>{p.value=!1,f.value=""},T=h(0),B=h(null),W=(r,a)=>{const n=new Date().getTime();n-T.value<300&&B.value===a?(r.stopPropagation(),r.preventDefault(),O(a.imgsrc),T.value=0,B.value=null):(T.value=n,B.value=a)},_=$(()=>e.value.filter(r=>r.status==="pending")),X=r=>!i.value||r<0||r>=i.value.length?[]:i.value[r]||[],q=(r,a)=>l.value===r&&o.value===a,G=(r,a)=>l.value===r&&o.value===a&&s.value.zone!==r,H=(r,a,n,v)=>{r.dataTransfer.dropEffect="move",r.dataTransfer.effectAllowed="move",r.dataTransfer.setData("itemId",a.id.toString()),s.value={zone:n,index:v},r.target.classList.add("dragging")},J=r=>{r&&r.target&&r.target.classList.remove("dragging"),l.value=null,o.value=-1},K=(r,a)=>{r.preventDefault(),l.value=a;const n=V(a);o.value=n?n.length:0},Q=(r,a,n)=>{r.preventDefault(),l.value=a,o.value=n},V=r=>r==="pending"?_.value:r>=0&&r<i.value.length?i.value[r]:[];return{rankid:I,items:e,pendingItems:_,ranklist:S,rankItems:i,getRankItems:X,dragOverZone:l,dragOverIndex:o,dragSource:s,showPreview:q,isPreviewActive:G,startDrag:H,endDrag:J,onDrop:(r,a)=>{r.preventDefault();try{const n=parseInt(r.dataTransfer.getData("itemId"));if(isNaN(n))return;const v=s.value.zone,g=s.value.index;if(v==="pending"){if(g<0||g>=e.value.length)return}else if(!i.value[v]||g<0||g>=i.value[v].length)return;let u;if(v==="pending"?g>=0&&g<e.value.length&&(u={...e.value[g]},e.value.splice(g,1)):i.value[v]&&g>=0&&g<i.value[v].length&&(u={...i.value[v][g]},i.value[v].splice(g,1)),!u||!u.id)return;if(a==="pending"){e.value=e.value.filter(F=>F.id!==u.id);const w=o.value===-1?e.value.length:Math.min(o.value,e.value.length);e.value.splice(w,0,u)}else{i.value[a]||(i.value[a]=[]),i.value[a]=i.value[a].filter(F=>F.id!==u.id);const w=o.value===-1?i.value[a].length:Math.min(o.value,i.value[a].length);i.value[a].splice(w,0,u)}l.value=null,o.value=-1}catch(n){console.error("拖拽处理错误:",n)}},onDragOver:K,onItemDragOver:Q,showImgPreview:p,previewImgSrc:f,handleImgZoom:O,closeImgPreview:j,handleTouchStart:W,imageList:R,handleFileChange:L,handleImgError:r=>{console.error(`图片加载失败: ${r.imgsrc}`),r.status="error"}}}},ae={id:"app"},te={class:"container"},le=["src"],oe={class:"main-content"},se={class:"tiers-container"},ie=["onDrop","onDragover"],ge=["onDragstart","onDragover","onDblclick","onTouchstart"],ce=["src","onError"],ve={key:1,class:"item-icon"},ue={class:"items-container"},de=["onDragstart","onDragover","onDblclick","onTouchstart"],me=["src","onError"],fe={class:"upload-btn",color:"#BFBFBF",for:"imageUpload"};function he(D,t,I,e,i,S){return m(),d("div",ae,[c("div",te,[e.showImgPreview?(m(),d("div",{key:0,class:"img-preview-layer",onClick:t[2]||(t[2]=(...l)=>e.closeImgPreview&&e.closeImgPreview(...l))},[c("img",{class:"preview-img",src:e.previewImgSrc,alt:"放大预览",onClick:t[0]||(t[0]=k(()=>{},["stop"]))},null,8,le),c("div",{class:"preview-close",onClick:t[1]||(t[1]=(...l)=>e.closeImgPreview&&e.closeImgPreview(...l))},"X")])):y("",!0),t[12]||(t[12]=c("div",{class:"header"},[c("h1",null,"排行榜热门投票")],-1)),c("div",oe,[c("div",se,[(m(!0),d(P,null,b(e.ranklist,(l,o)=>(m(),d("div",{key:o,class:A(["tier",l.color])},[c("div",{class:"tier-label",style:ee({backgroundColor:"#"+l.color})},re(l.name)+"级",5),c("div",{class:"tier-content",onDrop:s=>e.onDrop(s,o),onDragover:k(s=>e.onDragOver(s,o),["prevent"]),onDragenter:t[4]||(t[4]=k(()=>{},["prevent"]))},[(m(!0),d(P,null,b(e.getRankItems(o),(s,p)=>(m(),d(P,{key:s.id},[e.showPreview(o,p)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive(o,p)}])},null,2)):y("",!0),c("div",{class:"drag-item",draggable:"true",onDragstart:f=>e.startDrag(f,s,o,p),onDragend:t[3]||(t[3]=(...f)=>e.endDrag&&e.endDrag(...f)),onDragover:k(f=>e.onItemDragOver(f,o,p),["prevent"]),onDblclick:f=>e.handleImgZoom(s.imgsrc),onTouchstart:f=>e.handleTouchStart(f,s)},[s.imgsrc?(m(),d("img",{key:0,src:s.imgsrc,class:"item-image",alt:"",loading:"lazy",onError:f=>e.handleImgError(s)},null,40,ce)):(m(),d("div",ve,"⭐"))],40,ge)],64))),128)),e.showPreview(o,e.getRankItems(o).length)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive(o,e.getRankItems(o).length)}])},null,2)):y("",!0)],40,ie)],2))),128))]),c("div",ue,[t[11]||(t[11]=c("div",{class:"items-title"},"待处理项目",-1)),c("div",{class:"items-grid",onDrop:t[6]||(t[6]=l=>e.onDrop(l,"pending")),onDragover:t[7]||(t[7]=k(l=>e.onDragOver(l,"pending"),["prevent"])),onDragenter:t[8]||(t[8]=k(()=>{},["prevent"]))},[(m(!0),d(P,null,b(e.pendingItems,(l,o)=>(m(),d(P,{key:l.id},[e.showPreview("pending",o)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive("pending",o)}])},null,2)):y("",!0),c("div",{class:"drag-item",draggable:"true",onDragstart:s=>e.startDrag(s,l,"pending",o),onDragend:t[5]||(t[5]=(...s)=>e.endDrag&&e.endDrag(...s)),onDragover:k(s=>e.onItemDragOver(s,"pending",o),["prevent"]),onDblclick:s=>e.handleImgZoom(l.imgsrc),onTouchstart:s=>e.handleTouchStart(s,l)},[l.imgsrc?(m(),d("img",{key:0,src:l.imgsrc,class:"item-image",alt:"",loading:"lazy",onError:s=>e.handleImgError(l)},null,40,me)):y("",!0)],40,de)],64))),128)),e.showPreview("pending",e.pendingItems.length)?(m(),d("div",{key:0,class:A(["drop-preview",{active:e.isPreviewActive("pending",e.pendingItems.length)}])},null,2)):y("",!0)],32),c("label",fe,[t[10]||(t[10]=c("span",null,"选择图片（可多选）",-1)),c("input",{type:"file",id:"imageUpload",accept:"image/*",class:"hidden-input",onChange:t[9]||(t[9]=(...l)=>e.handleFileChange&&e.handleFileChange(...l)),multiple:""},null,32)])])]),t[13]||(t[13]=c("div",{class:"footer"},[c("p",null,"SABC分级拖拽系统 © 2023")],-1))])])}const ke=Y(ne,[["render",he]]);export{ke as default};
